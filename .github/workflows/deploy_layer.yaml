on:
  workflow_call: 
    inputs:
      target-layer:
        required: true
        type: string
      target-env:
        required: true
        type: string

    secrets:
      auth0-client-id:
        required: true
      auth0-client-secret:
        required: true
      auth0-domain:
        required: true
      arm-client-id:
        required: true
      arm-client-secret:
        required: true
      arm-subscription-id:
        required: true
      arm-tenant-id:
        required: true
      pulumi-config-passphrase:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-22.04
    name: Deploy ${{ inputs.target-env }}
    env:
      STACK_NAME: ${{ inputs.target-env }}
      TARGET_LAYER_NAME: ${{ inputs.target-layer }}
      
      AUTH0_CLIENT_ID: ${{ inputs.auth0-client-id }}
      AUTH0_CLIENT_SECRET: ${{ inputs.auth0-client-secret }}
      AUTH0_DOMAIN: ${{ inputs.auth0-domain }}

      ARM_CLIENT_ID: ${{ inputs.arm-client-id }}
      ARM_CLIENT_SECRET: ${{ inputs.arm-client-secret }}
      ARM_SUBSCRIPTION_ID: ${{ inputs.arm-subscription-id }}
      ARM_TENANT_ID: ${{ inputs.arm-tenant-id }}

      PULUMI_CONFIG_PASSPHRASE: ${{ inputs.pulumi-passphrase }}

      INFRA_PROJECT_PATH: ${{ github.workspace }}/src/Officify.Infra.Host
      INFRA_STATE_CONTAINER_NAME: 'officify-infra'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v3
        with:
          global-json-file: global.json

      - run: dotnet tool restore
        name: Restore Dotnet Tools

      - run: dotnet restore --locked-mode
        name: Restore Packages

      - run: ${{ github.workspace }}/infra-login.sh
        name: Login To Infra

      - uses: pulumi/actions@v4
        name: Deploy Changes
        with:
          command: up
          cloud-url: azblob://${{ env.INFRA_STATE_CONTAINER_NAME }}
          stack-name: ${{ env.STACK_NAME }}
          work-dir: ${{ env.INFRA_PROJECT_PATH }}